<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Data Grid Example</title>

    <style>
        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }
    </style>
    <script type="module" src="../js/dataGrid.js"></script>
    <script type="module">
        const fields = {
            plate: 'TEXT',
            state: 'TEXT',
            license_type: 'TEXT',
            summons_number: 'INTEGER',
            issue_date: 'TEXT',
            violation_time: 'TEXT',
            violation: 'TEXT',
            precinct: 'TEXT',
            county: 'TEXT',
            issuing_agency: 'TEXT',
            violation: 'TEXT',
            amount_type: 'TEXT',
            value: 'REAL',
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Get NYC "Open Parking And Camera Violations" open dataset
            const response = await fetch('https://data.cityofnewyork.us/resource/uvbq-3m68.json');
            const data = await response.json();

            const cols = Object.keys(fields);
            const shared_cols = cols.filter(col => !['amount_type', 'value'].includes(col));
            const amount_cols = ['fine_amount', 'penalty_amount', 'interest_amount', 'reduction_amount'];
            // 'melt' data from wide to narrow format
            const rows = [];
            data.forEach((object) => {
                const shared = shared_cols.map(col => object[col]);
                amount_cols.forEach(amount_col => rows.push(shared.concat([amount_col, object[amount_col]])));
            });

            document.querySelector('data-grid').addEventListener('component-ready', async ({ target }) => {
                await target.createTable(fields);
                await target.bulkInsert(cols, rows);
                await target.refresh();
            }, { once: true });
        });
    </script>
</head>

<body>
    <data-grid data-name="violations" data-db-name="example"></data-grid>
</body>

</html>